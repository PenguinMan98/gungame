<html>
<head>
    <style>
        body{
            background: #ddd;
        }
        #game-canvas{
            height: 400px;
            width: 600px;
            background: #bbb;
        }
    </style>
</head>
<body>
    <h1>Gun Game</h1>

    <canvas id="game-canvas" width="600" height="400" />

    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://rawgit.com/amark/gun/master/gun.js"></script>
    <script src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>
    <script>
        var gunServer = "https://gungame.herokuapp.com/gun";

        var colors = [
                "red",
                "pink",
                "blue",
                "orange",
                "green",
                "purple",
                "black",
                "white",
                "magenta",
                "yellow",
                "cyan"
        ];

//        var gameApi = (function(window, $){
//            console.log('loading gameapi');
//            var gun;
//            var self = this;
//
//
//            var saveState = function( myGuid, x, y, r, color){
//                console.log( 'put my state', myGuid, x, y, r, color );
//            };
//
//            var publicApi = {
//                init: function( gun ){
//                    self.gun = gun;
//                },
//                saveMyState: function( s ){
//                    saveState(s.myGuid, s.x, s.y, s.r, s.color );
//                    self.gun.path(s.myGuid).put(s);
//                }
//            };
//
//            return publicApi;
//        })(window, $);
//
//        console.log('gameapi is', gameApi);

        $(function(){
            var gun = Gun(gunServer).get('penguinman98/3');
            var gunLocal = Gun().get('penguinman98/local');
            var gunBalls = gun.path('balls');

            var myGuid = 'abcd';

            var myState = {
                x: 50,
                y: 50,
                r: 40,
                id: 0,
                vx: 0,
                vy: 0,
                ax: 0,
                ay: 0,
                lastAction: 0,
                active: 1,
                selected: 0,
                owner: 'abcd',
                color: "red",
                lastStatusChange: Date.now()
            };

            //Create a stage by getting a reference to the canvas
            var stage = new createjs.Stage("game-canvas");
            //Create a Shape DisplayObject.
            var circle = new createjs.Shape();

            var shapeList = {};
            var objectList = {};

            var testObj1 = {
                x: 100,
                y: 50,
                r: 40,
                id: 1,
                vx: 1,
                vy: 0,
                ax: 0,
                ay: 0,
                lastAction: 0,
                active: 1,
                selected: 1,
                owner: 'abcd',
                color: "blue",
                lastStatusChange: Date.now()
            };

            var testObj2 = {
                x: 150,
                y: 50,
                r: 40,
                id: 2,
                vx: 0,
                vy: 1,
                ax: 0,
                ay: 0,
                lastAction: 0,
                active: 1,
                selected: 0,
                owner: 'abcd',
                color: "pink",
                lastStatusChange: Date.now()
            };

            var testObj3 = {
                x: 200,
                y: 50,
                r: 40,
                id: 3,
                vx: 1,
                vy: 1,
                ax: 0,
                ay: 0,
                lastAction: 0,
                active: 1,
                selected: 0,
                owner: 'abcd',
                color: "green",
                lastStatusChange: Date.now()
            };

            console.log('checking for myGuid');
            gunLocal.path('myGuid').not(function( path ){
                console.log('no guid found');
                gunLocal.path(path).put('abcd');
            }).val(function( localGuid ){
                console.log('localGuid', localGuid);
            });

            circle.graphics.beginFill(myState.color).drawCircle(0, 0, myState.r);
            circle.x = myState.x;
            circle.y = myState.y;
            stage.addChild(circle);

            console.log('circle', circle);

            var circleName;

            circleName = 'circle1';
            shapeList[circleName] = new createjs.Shape();
            objectList[circleName] = testObj1;
            updatePosition( shapeList[circleName], objectList[circleName]);
            stage.addChild(shapeList[circleName]);

            circleName = 'circle2';
            shapeList[circleName] = new createjs.Shape();
            objectList[circleName] = testObj2;
            updatePosition( shapeList[circleName], objectList[circleName]);
            stage.addChild(shapeList[circleName]);

            circleName = 'circle3';
            shapeList[circleName] = new createjs.Shape();
            objectList[circleName] = testObj3;
            updatePosition( shapeList[circleName], objectList[circleName]);
            stage.addChild(shapeList[circleName]);


            function updatePosition( circle, state ){
                // redraw the circle
                circle.graphics.beginFill( state.color).drawCircle(0, 0, state.r);
                circle.x = state.x;
                circle.y = state.y;
            }

            createjs.Ticker.on("tick", handleTick);
            function handleTick() {
                // On each tick, redraw the scene
                var thisCircle;
                var thisState;

                for( var i = 0; i < 8; i++ ){
                    circleName = 'circle' + i;
                    if( !shapeList[circleName] ){ continue; } // if this shape id doesn't exist or is null, skip it
                    thisCircle = shapeList[circleName]; // shortcut reassignment
                    thisState = objectList[circleName];
                    if( thisState.vx != 0 || thisState.vy != 0 ){
                        // get my position and velocity at the last update
                        // look at the current timestamp
                        // calculate my current position

                        thisState.x += thisState.vx;
                        thisState.y += thisState.vy;
                    }
                    updatePosition( thisCircle, thisState); // update my position
                }

                stage.update(); // subsequently calls tick() with the same param
            }



            console.log('beginning gun test');

            // get updates from the server for where the balls should be and how they should be moving
            gunBalls.map(function(val, key){
                if( val && val.id){ // If the id is set, assume it a valid ball object. TODO: Validate this better.
                    // look for the shape in the array
                    if( shapeList[key] ){
                        // if it's here, update the shape
                        updatePosition(shapeList[key],val);
                        // and store the state
                        objectList[key] = val;
                    }else{
                        // if it's not here, make a new one
                        shapeList[key] = new createjs.Shape();
                        // update the shape
                        updatePosition( shapeList[key], val);
                        // add it to the stage
                        stage.addChild(shapeList[key]);
                        // store the state
                        objectList[key] = val;
                    }
                    // flush changes
                    stage.update();
                }else{
                    // invalid id or object is null
                    if( shapeList[key] ){ // if the key exists
                        stage.removeChild(shapeList[key]); // remove it.
                        delete shapeList[key];
                        delete objectList[key];
                    }
                    // flush changes
                    stage.update();
                }
            });

            circleName = 'circle' + testObj1.id;
            gunBalls.path(circleName).put(testObj1);

            circleName = 'circle' + testObj2.id;
            gunBalls.path(circleName).put(testObj2);

            circleName = 'circle' + testObj3.id;
            gunBalls.path(circleName).put(testObj3);

            setTimeout(function(){
                circleName = 'circle' + testObj3.id;
                gunBalls.path(circleName).put(testObj3);
            }, 1000);
            setTimeout(function(){
                console.log('add 4');
                circleName = 'circle' + 4;
                gunBalls.path(circleName).put({
                    x: 250,
                    y: 50,
                    r: 40,
                    id: 3,
                    vx: 0,
                    vy: 0,
                    ax: 0,
                    ay: 0,
                    lastAction: 0,
                    active: 1,
                    selected: 0,
                    owner: 'abcd',
                    color: "black"
                });
            }, 2000);
            setTimeout(function(){
                console.log('remove 4');
                circleName = 'circle' + 4;
                gunBalls.path(circleName).put(null);
            }, 3000);
            setTimeout(function(){}, 4000);
            setTimeout(function(){}, 5000);
            setTimeout(function(){}, 6000);


            //drawCircle( myState );

            /*window.gameApi.init( gun );
            //window.gameApi.saveMyState( myState );

            gun.val( function( value ){
                console.log('getting my state', value);
                var playerList = value;
                delete playerList['_'];
                myGuid = Object.keys(playerList).length + 1;

                myState.myGuid = myGuid;
                drawCircle(myState);
                gameApi.saveMyState(myState);
            });

            gun.map().on( function( node, path ){
                console.log(' player', path, 'had state', node);
            } );

            circle.addEventListener("click", function(event){ changeColor() });*/
            /*function changeColor(){
                // Click happenened
                // let's change color
                var newColor = colors[Math.floor(Math.random()*colors.length)];
                console.log('new color', newColor);

                myState.color = newColor;

                if(myGuid > 0){
                    drawCircle( myState );
                    gameApi.saveMyState( myState );
                }

            }

            function drawCircle( state, add ){

                circle.graphics.beginFill(state.color).drawCircle(0, 0, state.r);
                //Set position of Shape instance.
                circle.x = state.x;
                circle.y = state.y;

                if(add){
                    //Add Shape instance to stage display list.
                    stage.addChild(circle);
                }
                //Update stage will render next frame
                stage.update();

            }*/


            /*circle.addEventListener("mousedown", function(event) {
                // A mouse press happened.
                // Listen for mouse move while the mouse is down:
                event.addEventListener("mousemove", handleMove);
            });*/


        });

    </script>
</body>
</html>